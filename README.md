# Description
Entity Framework Core Code First Approach. This project using ASP .NET Core Web API project template with modification. Using Entity Framework Core for object-database mapper (ORM).

# Create Sample Project

Open Visual Studio 2019 and create new project using **ASP.NET Core Web API**. Project Name : efcorecodefirstapi.

![CreateNewProject1](images/CreateNewProject1.jpg?raw=true)
![CreateNewProject2](images/CreateNewProject2.jpg?raw=true)
![CreateNewProject3](images/CreateNewProject3.jpg?raw=true)

# Project Content
Project Content using default ASP .NET Core Web API project template with some additional and modification.  
1. config  
This directory contain appsettings.json moved from app root directory.
2. DataAccess  
This directory contain ApplicationDbContext
3. Models  
This directory contains Entities and ViewModel. **Entities** contains database entities class. **ViewModel** contains view model class.

![OrganizeModels](images/OrganizeModels.jpg?raw=true)

## appsettings.json
Move appsettings.json from project root directory to config directory. Update appsettings.json :  
    
    {
        "Logging": {
            "LogLevel": {
            "Default": "Information",
            "Microsoft": "Warning",
            "Microsoft.Hosting.Lifetime": "Information"
            }
        },
        "ConnectionStrings": {
            "AppConnStr": "Data Source=.;initial catalog=EFCoreDemo;user id=sa;password=P@ssw0rd"
        },
        "AllowedHosts": "*"
    }

## Program.cs
Update Program.cs :

    public class Program
    {
        public static void Main(string[] args)
        {
            CreateHostBuilder(args).Build().Run();
        }

        public static IHostBuilder CreateHostBuilder(string[] args) =>
            Host.CreateDefaultBuilder(args)
                .ConfigureAppConfiguration(c => {
                    c.AddJsonFile("config/appsettings.json", optional: true, reloadOnChange: true);
                })
                .ConfigureWebHostDefaults(webBuilder =>
                {
                    webBuilder.UseStartup<Startup>();
                });
    }

## WeatherForecast
This controller generated by visual studio project template (ASP .NET Core Web Api). By default, this controller use WeatherForecast model (project root folder). We need to organize folder structure like this :

![OrganizeModels](images/OrganizeModels.jpg?raw=true)


Update WeatherForecast.cs

    public class WeatherForecastViewModel
    {
        public DateTime Date { get; set; }

        public int TemperatureC { get; set; }

        public int TemperatureF => 32 + (int)(TemperatureC / 0.5556);

        public string Summary { get; set; }
    }

Update WeatherForecastController.cs on Get Method :

        [HttpGet]
        public IEnumerable<WeatherForecastViewModel> Get()
        {
            var rng = new Random();
            return Enumerable.Range(1, 5).Select(index => new WeatherForecastViewModel
            {
                Date = DateTime.Now.AddDays(index),
                TemperatureC = rng.Next(-20, 55),
                Summary = Summaries[rng.Next(Summaries.Length)]
            })
            .ToArray();
        }


## Entity Framework Code First
1. Create Entity Class inside folder Models -> Entities : **Command** and **Platform**
2. Install Nugget Package :

        Install-Package Microsoft.EntityFrameworkCore.SqlServer
        Install-Package Microsoft.EntityFrameworkCore.Tools
        Install-Package Microsoft.EntityFrameworkCore.Design

3. Create DbContext Class inside folder DataAccess : [**ApplicationDbContext**](src/efcorecodefirstapi/efcorecodefirstapi/DataAccess/ApplicationDbContext.cs)

4. Update Startup.cs on ConfigureServices method and using section ([**Startup.cs**](src/efcorecodefirstapi/efcorecodefirstapi/Startup.cs))

        using efcorecodefirstapi.DataAccess;

        public void ConfigureServices(IServiceCollection services)
        {

            var sqlConnectionString = Configuration.GetConnectionString("AppConnStr");
            services.AddDbContext<ApplicationDbContext>(options => options.UseSqlServer(sqlConnectionString));

            services.AddControllers();
            services.AddSwaggerGen(c =>
            {
                c.SwaggerDoc("v1", new OpenApiInfo { Title = "efcorecodefirstapi", Version = "v1" });
            });
        }

4. Add Migration  
    Open Package Manager Console and run this commmand, format :

        Add-Migration {MigrationName}

    Example :

        Add-Migration Initial

    ![AddMigration](images/AddMigration.jpg?raw=true)

5. Update Database 
    Using Package Manager Console use this command format :

        Update-Database

    Database before :  
    ![Db1](images/Db1.jpg?raw=true)

    Database after :  
    ![Db2](images/Db2.jpg?raw=true)

## Sample Command Controller

Now, we have project structure that we need. Next we create sample controller to use ApplicationDbContext (**CommandController**).  
1. Create New Class **CommandController** inside **Controllers** directory
2. Update **CommandController** content

        [ApiController]
        [Route("[controller]")]
        public class CommandController : ControllerBase
        {
            private readonly ILogger<CommandController> _logger;
            private readonly ApplicationDbContext _dbcontext;

            public CommandController(ILogger<CommandController> logger, ApplicationDbContext dbcontext)
            {
                _logger = logger;
                _dbcontext = dbcontext;
            }

            [HttpGet]
            public IEnumerable<CommandViewModel> Get()
            {
                return _dbcontext.Commands.Select(d => new CommandViewModel()
                {
                    CommandLine = d.CommandLine,
                    HowTo = d.HowTo,
                    Id = d.Id,
                    PlatformId = d.PlatformId,
                    PlatformLicenseKey = d.Platform.LicenseKey,
                    PlatformName = d.Platform.Name
                }).ToList();
            }
        }

    Make sure use this namespace on using section : 

        using efcodefirstapi.DataAccess;
        using efcodefirstapi.Models.ViewModel;

Run Apps for testing :

![RunApps1](images/RunApps1.jpg?raw=true)
![RunApps2](images/RunApps2.jpg?raw=true)


# Reference
https://www.entityframeworktutorial.net/efcore/entity-framework-core.aspx  
https://docs.microsoft.com/en-us/ef/efcore-and-ef6/  
https://www.learnentityframeworkcore.com/  
https://docs.microsoft.com/en-us/ef/core/get-started/?tabs=netcore-cli  
https://docs.microsoft.com/en-us/ef/core/cli/powershell  